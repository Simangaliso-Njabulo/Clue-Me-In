@page "/play"
@inject WordsService WordsService

<div class="card-container">

    <FluentStack HorizontalGap="15" HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Bottom" Width="90%" class="button-stack">

        <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Left">
            <FluentSelect Label="Category" @bind-Value="selectedCategory"
                          @onchange="OnCategoryChanged"
                          Items="categories" />
        </FluentStack>

        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Right">
            <FluentButton IconEnd="@(new Icons.Regular.Size20.CheckmarkCircle().WithColor(Color.Success))" OnClick="OnCorrect">Correct</FluentButton>
            <FluentButton IconEnd="@(new Icons.Regular.Size20.DismissCircle().WithColor(Color.Error))" OnClick="OnIncorrect">Incorrect</FluentButton>
            <FluentButton IconEnd="@(new Icons.Regular.Size20.ArrowCircleRight().WithColor(Color.Info))" OnClick="OnSkip">Skip</FluentButton>
        </FluentStack>

    </FluentStack>

    <FluentCard class="card">
        <p class="card-text">@currentWord</p>
    </FluentCard>

</div>

@code {
    private List<string> words = new List<string>();
    private List<string> usedWords = new List<string>();
    private string currentWord = string.Empty;
    private List<string> categories = new List<string>();
    private string selectedCategory = string.Empty; // Selected category

    protected override async Task OnInitializedAsync()
    {
        categories = await WordsService.GetCategoriesAsync(); // Get the available categories
        if (categories.Count > 0)
        {
            selectedCategory = categories[0]; // Set default selected category if available
            await LoadWordsForSelectedCategory(); // Load words for the default category
        }
    }

    private async Task LoadWordsForSelectedCategory()
    {
        words = await WordsService.GetWordsAsync(selectedCategory); // Get the words from the selected category
        ShuffleWords(); // Shuffle the words
        GetNextWord(); // Get the first word to display
    }

    private void OnCategoryChanged(ChangeEventArgs e)
    {
        selectedCategory = e.Value.ToString(); // Update selected category
        LoadWordsForSelectedCategory(); // Load words for the newly selected category
    }

    private void ShuffleWords()
    {
        Random rng = new Random();
        int n = words.Count;
        while (n > 1)
        {
            int k = rng.Next(n--);
            (words[n], words[k]) = (words[k], words[n]); // Swap elements
        }
    }

    private void GetNextWord()
    {
        if (usedWords.Count < words.Count)
        {
            // Get the next word that hasn't been used
            currentWord = words[usedWords.Count];
            usedWords.Add(currentWord); // Mark this word as used
        }
        else
        {
            currentWord = "No more words available!"; // Inform the user when all words have been used
        }
    }

    // Handle the "Correct" button click
    private void OnCorrect()
    {
        GetNextWord();
    }

    // Handle the "Incorrect" button click
    private void OnIncorrect()
    {
        GetNextWord();
    }

    // Handle the "Skip" button click
    private void OnSkip()
    {
        GetNextWord();
    }
}
